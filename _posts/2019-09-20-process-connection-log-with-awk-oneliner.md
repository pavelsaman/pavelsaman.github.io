---
layout: page
title:  "Process Connection Log with Awk"
date:   2019-09-20 14:07:19 +0200
categories: linux
---

Awk is a useful tool for text processing. I've recently wanted to process a log generated by Network Manager. I'll show you just a simple awk script that helped me get the data I wanted. I find it useful to get some practice in awk, so I'll try out some awk oneliners here.

The log is in two file in `/var/log`:

```bash
-rw-r--r--   1 root   root            4.6K Sep 20 15:10 NetworkManager-dispatcher.d.log
-rw-r--r--   1 root   root             11K Sep 15 00:00 NetworkManager-dispatcher.d.log.1
```

The file content is in the following format:

```
2019-09-13T19:16:28,914713963+00:00 | DEVICE: wlp2s0 | STATUS: up | UUID: 3d4d912a-6432-4a36-8cf2-1b2acf115134 | ID: test | IP4_GATEWAY: 192.168.1.1 | IP4_NAMESERVERS: 8.8.8.8
2019-09-14T08:41:05,898951891+00:00 | DEVICE: eno1 | STATUS: up | UUID: ac187d12-fffe-35e9-bbca-91f79cea61f1 | ID: Wired connection 1 | IP4_GATEWAY: 192.168.1.1 | IP4_NAMESERVERS: 8.8.8.8
2019-09-14T08:41:06,766934167+00:00 | DEVICE: wlp2s0 | STATUS: up | UUID: 3d4d912a-6432-4a36-8cf2-1b2acf115134 | ID: test | IP4_GATEWAY: 192.168.1.1 | IP4_NAMESERVERS: 8.8.8.8
2019-09-14T16:15:19,264672512+00:00 | DEVICE: eno1 | STATUS: up | UUID: ac187d12-fffe-35e9-bbca-91f79cea61f1 | ID: Wired connection 1 | IP4_GATEWAY: 192.168.1.1 | IP4_NAMESERVERS: 8.8.8.8
2019-09-14T16:15:20,021135139+00:00 | DEVICE: wlp2s0 | STATUS: up | UUID: 3d4d912a-6432-4a36-8cf2-1b2acf115134 | ID: test | IP4_GATEWAY: 192.168.1.1 | IP4_NAMESERVERS: 8.8.8.8
2019-09-15T21:04:26,478777580+00:00 | DEVICE: wlp2s0 | STATUS: down | UUID: 016ebf86-842e-4551-8e21-3d33559f1219 | ID: Test | IP4_GATEWAY:  | IP4_NAMESERVERS: 
```

For every `up` or `down` status, there's one line with date and time, device name, status, UUID of the network, ID of the network, IPv4 address, and an array of nameservers.

I'll now run a few awk commands to process the file and get some interesting statistics.

#### I want to know how many times I've connected to a network:

```bash
$ awk -F'|' '($3 ~ /up/) { c++ } END {print c}' /var/log/NetworkManager-dispatcher.d.log*
```

No need to write `if`, I can just type `(pattern)` and apply `{action}`. 

#### I want to know what networks I've connected to:

```bash
$ awk -F'|' '($3 ~ /up/) {net[$4]++} END{for (n in net) {print substr(n,2)}}' /var/log/NetworkManager-dispatcher.d.log*
```

Awk has some functions I can use. I can even create my own functions in awk.

#### I want to know what networks I've connected to + how many times:

```bash
$ awk -F'|' '($3 ~ /up/) {net[$4]++} END{for (n in net) {print substr(n,index(n,":")+2,length(substr(n,index(n,":")+2))-1),net[n]}}' OFS='|' /var/log/NetworkManager-dispatcher.d.log*
```
`OFS` changes the Output Field Separator. I can also beautify the output by getting rif od some whitespaces etc. by using `substr`, `index`, and `length` functions.

#### I want to add the network ID to the previous output

```bash
$ awk -F'|' '($3 ~ /up/) {net[substr($5,index($5,":")+2,length(substr($5,index($5,":")+2))-1) "|" substr($4,index($4,":")+2,length(substr($4,index($4,":")+2))-1)]++} END{for (n in net) {print n,net[n]}}' OFS='|' /var/log/NetworkManager-dispatcher.d.log*
```

In awk I can really play around with the key of an associative array.

#### I want to know what IP addresses I've had:

```bash
$ awk -F'|' '($3 ~ /up/) {net[$6]++} END{for (n in net) {print substr(n,2)}}' /var/log/NetworkManager-dispatcher.d.log*
```

Awk has associative arrays, so it's easy to use some data as a key.

#### I want to create a file named after an ID of a connection and save all times I've connected to such a network into the file:

```bash
$ awk -F'|' '($3 ~ /up/) {print $1 > substr($5,index($5,":")+2,length(substr($5,index($5,":")+2))-1)}' /var/log/NetworkManager-dispatcher.d.log*
```

Awk can create files for me and I can use redirection in awk.

This is how awk works. Just a few notes at the end:
1. awk uses pattern-action patters; patterns are in `()`, actions in `{}`, when a pattern gets evaluated to true, action is taken
2. awk has associative arrays, so it's easy to use a piece of data as a key
3. there are some built-in variables in awk:
![image](/images/awk_vars.png)
4. it's possible to write a script in awk and save it as a file, the first line would be `#!/usr/bin/awk`
5. awk can redirect output to a file, it's even possible to use shell from within an awk script